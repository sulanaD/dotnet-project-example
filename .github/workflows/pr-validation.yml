name: PR Validation

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [ main, develop ]

jobs:
  pr-validation:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Shallow clones disabled for better analysis
        
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
        
    - name: Restore dependencies
      run: dotnet restore example-web-app.sln
      
    - name: Check code formatting
      run: |
        dotnet format example-web-app.sln --verify-no-changes --verbosity diagnostic
        
    - name: Build solution
      run: dotnet build example-web-app.sln --no-restore --configuration Release
      
    - name: Run tests with coverage
      run: |
        mkdir -p ./TestResults
        dotnet test example-web-app.sln \
          --no-build \
          --configuration Release \
          --verbosity normal \
          --collect:"XPlat Code Coverage" \
          --results-directory ./TestResults \
          --logger trx \
          --logger "console;verbosity=detailed"
          
    - name: Validate test coverage
      run: |
        # Check if we have at least 70% code coverage
        dotnet tool install -g dotnet-reportgenerator-globaltool
        reportgenerator -reports:"TestResults/**/coverage.cobertura.xml" -targetdir:"coveragereport" -reporttypes:TextSummary
        
        coverage=$(grep -oP '(?<=Line coverage: )\d+(?=\.\d+%)' coveragereport/Summary.txt || echo "0")
        echo "Current line coverage: ${coverage}%"
        
        if [ "$coverage" -lt "70" ]; then
          echo "‚ùå Code coverage is below 70% threshold (current: ${coverage}%)"
          exit 1
        else
          echo "‚úÖ Code coverage meets threshold (current: ${coverage}%)"
        fi
        
    - name: Check for security vulnerabilities
      run: |
        echo "üîç Scanning for security vulnerabilities..."
        dotnet list package --vulnerable --include-transitive 2>&1 | tee security-check.txt
        if grep -q 'has the following vulnerable packages' security-check.txt; then
          echo "‚ùå Security vulnerabilities found in dependencies!"
          echo "üìã Vulnerability details:"
          cat security-check.txt
          echo ""
          echo "üîß To fix these vulnerabilities:"
          echo "1. Update the vulnerable packages to their latest secure versions"
          echo "2. Add explicit package references to override transitive dependencies"
          echo "3. Verify fixes by running: dotnet list package --vulnerable --include-transitive"
          exit 1
        else
          echo "‚úÖ No security vulnerabilities found."
        fi
        
    - name: Comment PR with results
      uses: actions/github-script@v7
      if: always()
      with:
        script: |
          const fs = require('fs');
          
          let comment = '## üîç PR Validation Results\n\n';
          
          // Add coverage info if available
          try {
            const summaryPath = 'coveragereport/Summary.txt';
            if (fs.existsSync(summaryPath)) {
              const summary = fs.readFileSync(summaryPath, 'utf8');
              const coverageMatch = summary.match(/Line coverage: (\d+\.\d+%)/);
              if (coverageMatch) {
                const coverage = parseFloat(coverageMatch[1]);
                const emoji = coverage >= 70 ? '‚úÖ' : '‚ùå';
                comment += `${emoji} **Code Coverage**: ${coverageMatch[1]}\n`;
              }
            }
          } catch (e) {
            comment += '‚ö†Ô∏è **Code Coverage**: Unable to determine\n';
          }
          
          // Add security scan results
          try {
            const securityPath = 'security-check.txt';
            if (fs.existsSync(securityPath)) {
              const securityContent = fs.readFileSync(securityPath, 'utf8');
              const hasVulnerabilities = securityContent.includes('vulnerable');
              const emoji = hasVulnerabilities ? '‚ùå' : '‚úÖ';
              comment += `${emoji} **Security Scan**: ${hasVulnerabilities ? 'Vulnerabilities found' : 'No vulnerabilities'}\n`;
            }
          } catch (e) {
            comment += '‚ö†Ô∏è **Security Scan**: Unable to determine\n';
          }
          
          comment += '\n---\n*This comment is automatically updated by the PR validation workflow.*';
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
          
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: pr-test-results
        path: |
          TestResults/**/*.trx
          TestResults/
          coveragereport/